services:
  # MongoDB Primary
  mongo-primary:
    image: mongo:7.0
    container_name: chat-mongo-primary
    restart: unless-stopped
    entrypoint:
      - bash
      - -c
      - |
        echo ">> CHECK 1: Listing mounted folder..."
        ls -la /opt/keyfile/
        
        echo ">> CHECK 2: Copying keyfile..."
        if [ ! -f /opt/keyfile/mongo-keyfile ]; then
            echo "ERROR: File không tồn tại! Hãy tạo folder 'config' và để file 'mongo-keyfile' vào đó."
            exit 1
        fi
        
        cp /opt/keyfile/mongo-keyfile /tmp/mongo-keyfile
        
        echo ">> CHECK 3: Setting permissions..."
        chown 999:999 /tmp/mongo-keyfile
        chmod 400 /tmp/mongo-keyfile
        
        echo ">> CHECK 4: Starting MongoDB..."
        exec docker-entrypoint.sh mongod --replSet myReplicaSet --bind_ip_all --keyFile /tmp/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    ports:
      - "27017:27017"
    volumes:
      - mongo-primary-data:/data/db
      - ./config:/opt/keyfile:ro
    networks:
      - chat-network
    # --- PHẦN QUAN TRỌNG BỊ THIẾU ---
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    # --------------------------------

  # MongoDB Secondary 1
  mongo-secondary-1:
    image: mongo:7.0
    container_name: chat-mongo-secondary-1
    restart: unless-stopped
    entrypoint:
      - bash
      - -c
      - |
        cp /opt/keyfile/mongo-keyfile /tmp/mongo-keyfile
        chown 999:999 /tmp/mongo-keyfile
        chmod 400 /tmp/mongo-keyfile
        exec docker-entrypoint.sh mongod --replSet myReplicaSet --bind_ip_all --keyFile /tmp/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    volumes:
      - mongo-secondary1-data:/data/db
      - ./config:/opt/keyfile:ro
    networks:
      - chat-network
    depends_on:
      mongo-primary:
        condition: service_healthy

  # MongoDB Secondary 2
  mongo-secondary-2:
    image: mongo:7.0
    container_name: chat-mongo-secondary-2
    restart: unless-stopped
    entrypoint:
      - bash
      - -c
      - |
        cp /opt/keyfile/mongo-keyfile /tmp/mongo-keyfile
        chown 999:999 /tmp/mongo-keyfile
        chmod 400 /tmp/mongo-keyfile
        exec docker-entrypoint.sh mongod --replSet myReplicaSet --bind_ip_all --keyFile /tmp/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    volumes:
      - mongo-secondary2-data:/data/db
      - ./config:/opt/keyfile:ro
    networks:
      - chat-network
    depends_on:
      mongo-primary:
        condition: service_healthy

  # Init Replica Set
  # Init Replica Set (Đã nâng cấp: Chờ đủ cả 3 node)
  mongo-init:
    image: mongo:7.0
    container_name: chat-mongo-init
    depends_on:
      mongo-primary:
        condition: service_healthy
      mongo-secondary-1:
        condition: service_started
      mongo-secondary-2:
        condition: service_started
    entrypoint:
      - bash
      - -c
      - |
        # Hàm chờ một host cụ thể
        wait_for_mongo() {
          echo "Waiting for $1 to be ready..."
          until mongosh --host $1 --port 27017 --eval "quit(0)" > /dev/null 2>&1; do
            echo "$1 is not ready yet. Sleeping 2s..."
            sleep 2
          done
          echo "$1 is READY!"
        }

        # Chờ lần lượt cả 3 node
        wait_for_mongo "mongo-primary"
        wait_for_mongo "mongo-secondary-1"
        wait_for_mongo "mongo-secondary-2"
        
        echo ">> ALL NODES ARE READY! Starting Replica Set initialization..."
        
        # Khởi tạo Replica Set
        mongosh --host mongo-primary -u admin -p password123 --authenticationDatabase admin --eval "
        try {
          var status = rs.status();
          if (status.ok === 1) {
            print('Replica Set already initialized. Skipping.');
          } else {
             throw 'Not initialized';
          }
        } catch (err) {
          print('Initializing Replica Set...');
          var cfg = {
            _id: 'myReplicaSet',
            members: [
              { _id: 0, host: 'mongo-primary:27017', priority: 2 },
              { _id: 1, host: 'mongo-secondary-1:27017', priority: 1 },
              { _id: 2, host: 'mongo-secondary-2:27017', priority: 1 }
            ]
          };
          var res = rs.initiate(cfg);
          printjson(res);
        }"
    networks:
      - chat-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: chat-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass redis123
    volumes:
      - redis_data:/data
    networks:
      - chat-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend Server 1
  backend-1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: chat-backend-1
    restart: unless-stopped
    environment:
      PORT: 3000
      INSTANCE_NAME: server-1
      ATLAS_URI: mongodb://admin:password123@mongo-primary:27017,mongo-secondary-1:27017,mongo-secondary-2:27017/chat?authSource=admin&replicaSet=myReplicaSet&retryWrites=true
      JWT_SECRET: thangnaodocduoclamotnguoideptrai123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      NODE_ENV: production
    ports:
      - "3001:3000"
    depends_on:
      mongo-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - chat-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend Server 2
  backend-2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: chat-backend-2
    restart: unless-stopped
    environment:
      PORT: 3000
      INSTANCE_NAME: server-2
      ATLAS_URI: mongodb://admin:password123@mongo-primary:27017,mongo-secondary-1:27017,mongo-secondary-2:27017/chat?authSource=admin&replicaSet=myReplicaSet&retryWrites=true
      JWT_SECRET: thangnaodocduoclamotnguoideptrai123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      NODE_ENV: production
    ports:
      - "3002:3000"
    depends_on:
      mongo-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - chat-network

  # Backend Server 3
  backend-3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: chat-backend-3
    restart: unless-stopped
    environment:
      PORT: 3000
      INSTANCE_NAME: server-3
      ATLAS_URI: mongodb://admin:password123@mongo-primary:27017,mongo-secondary-1:27017,mongo-secondary-2:27017/chat?authSource=admin&replicaSet=myReplicaSet&retryWrites=true
      JWT_SECRET: thangnaodocduoclamotnguoideptrai123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      NODE_ENV: production
    ports:
      - "3003:3000"
    depends_on:
      mongo-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - chat-network

  # Nginx Load Balancer
  nginx-lb:
    image: nginx:alpine
    container_name: chat-nginx-lb
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      - ./nginx-lb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    networks:
      - chat-network

  # Frontend Web Server
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: chat-frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./fronted:/usr/share/nginx/html
    depends_on:
      - nginx-lb
    networks:
      - chat-network

volumes:
  mongo-primary-data:
    driver: local
  mongo-secondary1-data:
    driver: local
  mongo-secondary2-data:
    driver: local
  redis_data:
    driver: local

networks:
  chat-network:
    driver: bridge